<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro Commit JR - Completo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuração Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#0B375B',
                        'primary-light': '#1A82D9',
                        'accent-yellow': '#FAC835',
                        'coin-gold': '#FFD700',
                    }
                }
            }
        }
    </script>
    
    <!-- React e ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCasLIhPZ-eu_wisn0fNzNVEymGUouJaS0",
            authDomain: "minhas-finacas.firebaseapp.com",
            projectId: "minhas-finacas",
            storageBucket: "minhas-finacas.firebasestorage.app",
            messagingSenderId: "1056339749032",
            appId: "1:1056339749032:web:375d2b01c4cba2a32efa9d"
        };
        
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
    
    <style>
        body { background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .btn-primary { transition: background-color 0.2s ease, transform 0.1s; border-radius: 0.5rem; font-weight: 600; }
        .btn-primary:active { transform: scale(0.98); }
        .btn-nav { transition: all 0.2s ease; }

        @keyframes ring {
            0% { transform: rotate(0); }
            10% { transform: rotate(15deg); }
            20% { transform: rotate(-15deg); }
            30% { transform: rotate(10deg); }
            40% { transform: rotate(-10deg); }
            100% { transform: rotate(0); }
        }
        .bell-ring:hover { animation: ring 1.5s ease; }
        
        .coin-spin { animation: spin 3s linear infinite; }
        @keyframes spin { 100% { transform: rotateY(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- CONSTANTES ---
        const GLOBAL_DATA_ID = "main_financial_sheet";
        const LOGO_URL = "./araralogo.png"; 
        const COIN_IMAGE = "https://cdn-icons-png.flaticon.com/512/1292/1292744.png";

        // --- ÍCONES SVG ---
        const SVG_ICONS = {
            "users": `<path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" />`,
            "user-plus": `<path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" /><circle cx="8.5" cy="7" r="4" /><line x1="20" y1="8" x2="20" y2="14" /><line x1="23" y1="11" x2="17" y2="11" />`,
            "loader-2": `<path d="M21 12a9 9 0 1 1-6.219-8.56" />`,
            "calendar": `<rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><path d="M16 2L16 6M8 2L8 6M3 10L21 10" />`,
            "plus": `<path d="M12 5L12 19M5 12L19 12" />`,
            "minus": `<line x1="5" y1="12" x2="19" y2="12" />`,
            "log-out": `<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12L9 12" />`,
            "chevron-left": `<path d="M15 18l-6-6 6-6" />`,
            "chevron-right": `<path d="M9 18l6-6-6-6" />`,
            "check-circle": `<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3" />`,
            "circle": `<circle cx="12" cy="12" r="10" />`,
            "minus-circle": `<circle cx="12" cy="12" r="10" /><path d="M8 12L16 12" />`,
            "trash-2": `<path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6M10 11v6M14 11v6" />`,
            "bell": `<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9" /><path d="M13.73 21a2 2 0 0 1-3.46 0" />`,
            "clipboard": `<path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" /><rect x="8" y="2" width="8" height="4" rx="1" ry="1" />`,
            "check": `<polyline points="20 6 9 17 4 12" />`,
            "coins": `<circle cx="8" cy="8" r="6" /><path d="M18.09 10.37A6 6 0 1 1 10.34 18" /><path d="M7 6h1v4" /><path d="M17.12 10.06a4 4 0 1 0-4.42 4.42" />`,
            "shopping-bag": `<path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" /><line x1="3" y1="6" x2="21" y2="6" /><path d="M16 10a4 4 0 0 1-8 0" />`,
            "file-text": `<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z" /><polyline points="14 2 14 8 20 8" />`
        };

        const Icon = ({ name, size = 20, className = "stroke-current", style = {} }) => {
            const svgContent = SVG_ICONS[name];
            if (!svgContent) return null;
            return (
                <svg width={size} height={size} className={className} style={{ ...style, minWidth: size, minHeight: size }} viewBox="0 0 24 24" fill="none" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" dangerouslySetInnerHTML={{ __html: svgContent }} />
            );
        };
        
        const { useState, useEffect, useMemo, useCallback, useRef, createContext, useContext } = React;
        
        // --- FUNÇÕES UTILITÁRIAS ---
        const getMonthDifference = (startMonth, startYear, endMonth, endYear) => 
            (endYear - startYear) * 12 + (endMonth - startMonth);
        const getStatusKey = (id, index) => `${id}_${index}`;
        const formatDateForInput = (date) => {
            const d = new Date(date);
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const year = d.getFullYear();
            return `${year}-${month}-${day}`;
        };

        const saveDataToFirebase = (userRef, data) => {
            if (!userRef) return;
            userRef.set(data).catch(error => console.error("Erro ao salvar no Firebase:", error));
        };
        
        // --- COMPONENTES AUXILIARES ---

        const NotificationModal = ({ isOpen, onClose, alerts }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                            <h3 className="font-bold text-lg text-primary-dark flex items-center gap-2">
                                <Icon name="bell" size={20}/> Central de Alertas
                            </h3>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-700 font-bold text-xl">×</button>
                        </div>
                        <div className="p-4 overflow-y-auto flex-1">
                            {alerts.length === 0 ? (
                                <p className="text-gray-500 text-center py-8">Nenhum alerta pendente.</p>
                            ) : (
                                <ul className="space-y-3">
                                    {alerts.map((alert, idx) => (
                                        <li key={idx} className="border border-l-4 border-l-accent-yellow rounded-lg p-3 bg-white shadow-sm">
                                            <p className="font-bold text-gray-800">{alert.nome}</p>
                                            <p className="text-sm text-gray-600">Vence: Dia {alert.dia}</p>
                                            {alert.tipo !== 'tarefa' && <p className="text-sm font-semibold text-red-600">R$ {Number(alert.valor).toFixed(2)}</p>}
                                            {alert.responsavel && <p className="text-xs text-primary-dark mt-1 font-medium bg-primary-light/10 inline-block px-1 rounded">Resp: {alert.responsavel}</p>}
                                        </li>
                                    ))}
                                </ul>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, item }) => {
            if (!isOpen || !item) return null;
            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                        <div className="p-6">
                            <h3 className="font-bold text-lg text-gray-800 flex items-center gap-2 text-red-600"><Icon name="trash-2" size={20}/> Confirmar Exclusão</h3>
                            <p className="mt-4 text-gray-600">Tem certeza que deseja excluir <strong>{item.nome}</strong>?</p>
                        </div>
                        <div className="flex justify-end gap-3 p-4 bg-gray-50 border-t">
                            <button onClick={onClose} className="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-100">Cancelar</button>
                            <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Excluir</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- COMPONENTE COMMIT COIN (MEMBROS SEPARADOS) ---
        const CommitCoinView = ({ coinMembers, coinData, products, onUpdateCoins, onAddProduct, onDeleteProduct, onAddCoinMember, onDeleteCoinMember }) => {
            const [newProd, setNewProd] = useState({ name: '', price: '', img: '' });
            const [newMemberName, setNewMemberName] = useState('');
            const [amountToChange, setAmountToChange] = useState({});

            const handleProductSubmit = (e) => {
                e.preventDefault();
                if (!newProd.name || !newProd.price) return;
                onAddProduct({ ...newProd, price: parseInt(newProd.price) });
                setNewProd({ name: '', price: '', img: '' });
            };

            const handleAddMember = (e) => {
                e.preventDefault();
                if(!newMemberName.trim()) return;
                onAddCoinMember(newMemberName);
                setNewMemberName('');
            };

            const handleCoinChange = (memberId, amount) => {
                onUpdateCoins(memberId, amount);
                setAmountToChange({ ...amountToChange, [memberId]: '' });
            };

            return (
                <main className="max-w-6xl mx-auto px-4 py-6 space-y-8">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-primary-dark to-primary-light rounded-2xl p-6 text-white shadow-lg flex items-center justify-between">
                        <div>
                            <h2 className="text-3xl font-bold flex items-center gap-3">
                                <img src={COIN_IMAGE} className="w-10 h-10 coin-spin" /> CommitCoin
                            </h2>
                            <p className="text-white/80 mt-1">Sistema de Recompensas e Loja Virtual</p>
                        </div>
                        <div className="text-right hidden md:block">
                            <p className="text-4xl font-bold text-accent-yellow">{coinMembers.length}</p>
                            <p className="text-sm">Membros do Coin</p>
                        </div>
                    </div>

                    {/* Carteiras dos Membros (Coin Members) */}
                    <section>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-primary-dark flex items-center gap-2"><Icon name="users" size={20}/> Carteiras (Coin Members)</h3>
                            <div className="flex gap-2">
                                <input type="text" placeholder="Add Membro Coin..." className="px-3 py-1 border rounded-lg text-sm" value={newMemberName} onChange={e=>setNewMemberName(e.target.value)}/>
                                <button onClick={handleAddMember} className="bg-primary-dark text-white px-3 py-1 rounded-lg text-sm font-bold">+</button>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {coinMembers.map(member => {
                                const balance = coinData[member.id] || 0;
                                const inputVal = amountToChange[member.id] || '';
                                
                                return (
                                    <div key={member.id} className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col gap-3 relative group">
                                        <button onClick={() => onDeleteCoinMember(member.id, member.name)} className="absolute top-2 right-2 text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14}/></button>
                                        <div className="flex justify-between items-center pr-6">
                                            <span className="font-bold text-gray-700 truncate text-lg">{member.name}</span>
                                            <div className="flex items-center gap-1 bg-yellow-50 px-2 py-1 rounded-lg border border-yellow-100">
                                                <img src={COIN_IMAGE} className="w-4 h-4"/>
                                                <span className="font-bold text-yellow-600">{balance}</span>
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                placeholder="Qtd" 
                                                className="w-16 px-2 py-1 border rounded text-center outline-none focus:border-accent-yellow"
                                                value={inputVal}
                                                onChange={e => setAmountToChange({...amountToChange, [member.id]: e.target.value})}
                                            />
                                            <button onClick={() => handleCoinChange(member.id, Number(inputVal))} className="flex-1 bg-green-100 text-green-700 rounded hover:bg-green-200 flex justify-center items-center font-bold" disabled={!inputVal}><Icon name="plus" size={16}/></button>
                                            <button onClick={() => handleCoinChange(member.id, -Number(inputVal))} className="flex-1 bg-red-100 text-red-700 rounded hover:bg-red-200 flex justify-center items-center font-bold" disabled={!inputVal}><Icon name="minus" size={16}/></button>
                                        </div>
                                    </div>
                                );
                            })}
                            {coinMembers.length === 0 && <div className="col-span-full p-4 text-center text-gray-400 bg-white rounded-lg">Adicione membros específicos para o CommitCoin acima.</div>}
                        </div>
                    </section>

                    {/* Loja e Produtos */}
                    <section>
                        <h3 className="text-xl font-bold text-primary-dark mb-4 flex items-center gap-2"><Icon name="shopping-bag" size={20}/> Loja de Recompensas</h3>
                        
                        {/* Formulário de Produto */}
                        <div className="bg-white p-4 rounded-xl border border-gray-200 mb-6">
                            <form onSubmit={handleProductSubmit} className="flex flex-col md:flex-row gap-3">
                                <input required type="text" placeholder="Nome do Produto" className="flex-[2] px-3 py-2 border rounded-lg" value={newProd.name} onChange={e => setNewProd({...newProd, name: e.target.value})}/>
                                <input required type="number" placeholder="Preço (CC)" className="flex-1 px-3 py-2 border rounded-lg" value={newProd.price} onChange={e => setNewProd({...newProd, price: e.target.value})}/>
                                <input type="url" placeholder="URL da Imagem (opcional)" className="flex-[2] px-3 py-2 border rounded-lg" value={newProd.img} onChange={e => setNewProd({...newProd, img: e.target.value})}/>
                                <button type="submit" className="btn-primary bg-primary-dark text-white px-6 py-2">Adicionar</button>
                            </form>
                        </div>

                        {/* Grid de Produtos */}
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            {products.map(prod => (
                                <div key={prod.id} className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden group relative">
                                    <div className="aspect-square bg-gray-100 flex items-center justify-center relative overflow-hidden">
                                        {prod.img ? <img src={prod.img} className="w-full h-full object-cover" onError={(e) => e.target.src = COIN_IMAGE}/> : <img src={COIN_IMAGE} className="w-12 h-12 opacity-50 grayscale"/>}
                                        <div className="absolute top-2 right-2 bg-white/90 px-2 py-1 rounded-full text-xs font-bold text-primary-dark shadow-sm flex items-center gap-1"><img src={COIN_IMAGE} className="w-3 h-3"/> {prod.price}</div>
                                    </div>
                                    <div className="p-3">
                                        <h4 className="font-bold text-gray-800 text-sm truncate" title={prod.name}>{prod.name}</h4>
                                        <button onClick={() => onDeleteProduct(prod.id, prod.name)} className="absolute top-2 left-2 p-1 bg-white/80 rounded-full text-red-500 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-white"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                </div>
                            ))}
                            {products.length === 0 && <div className="col-span-full py-8 text-center text-gray-400">Nenhum produto na loja.</div>}
                        </div>
                    </section>
                </main>
            );
        };

        // --- NOVO COMPONENTE: QUADRO DE DESPESAS GERAIS ---
        const AllExpensesBoard = ({ expenses, onToggle, onDelete }) => {
            // Filtrar apenas despesas não pagas ou todas? Vamos mostrar todas, ordenadas por data
            const sorted = [...expenses].sort((a, b) => a.dia - b.dia);

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full min-h-[300px]">
                    <div className="bg-red-50 px-4 py-3 border-b border-red-100 flex justify-between items-center">
                        <h3 className="font-bold text-red-800 flex items-center gap-2">
                            <Icon name="file-text" size={18}/> Administração de Despesas
                        </h3>
                        <span className="text-xs font-bold bg-red-200 text-red-800 px-2 py-1 rounded-full">{expenses.length}</span>
                    </div>
                    <div className="flex-1 overflow-y-auto p-2 custom-scrollbar space-y-2">
                        {sorted.map(item => (
                            <div key={item.chaveStatus || item.id} className={`flex items-center justify-between p-3 rounded-lg border ${item.estaPago ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-red-100 shadow-sm'}`}>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => onToggle(item)} className={item.estaPago ? 'text-green-500' : 'text-gray-300 hover:text-red-500'}>
                                        <Icon name={item.estaPago ? "check-circle" : "circle"} size={20} />
                                    </button>
                                    <div>
                                        <p className={`text-sm font-bold ${item.estaPago ? 'text-gray-400 line-through' : 'text-gray-700'}`}>{item.nome}</p>
                                        <p className="text-xs text-gray-500 flex items-center gap-1">
                                            Vence dia {item.dia} 
                                            {item.responsavel && <span className="bg-gray-100 px-1 rounded text-gray-600 font-medium">{item.responsavel}</span>}
                                        </p>
                                    </div>
                                </div>
                                <div className="text-right flex flex-col items-end">
                                    <p className={`text-sm font-bold ${item.estaPago ? 'text-gray-400' : 'text-red-600'}`}>R$ {Number(item.valor).toFixed(2)}</p>
                                    <button onClick={() => onDelete(item.id, 'divida')} className="text-gray-300 hover:text-red-500 mt-1"><Icon name="trash-2" size={14}/></button>
                                </div>
                            </div>
                        ))}
                        {expenses.length === 0 && <p className="text-center text-gray-400 text-sm py-10">Nenhuma despesa cadastrada para este período.</p>}
                    </div>
                </div>
            );
        };

        // --- COMPONENTE QUADRO DE TAREFAS (MEMBROS CALENDÁRIO) ---
        const TaskBoard = ({ members, tasks, onAddMember, onDeleteMember, onToggleTask, onDeleteTask }) => {
            const [newMemberName, setNewMemberName] = useState('');

            const handleAdd = (e) => {
                e.preventDefault();
                if (!newMemberName.trim()) return;
                onAddMember(newMemberName);
                setNewMemberName('');
            };

            return (
                <div className="space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 border-b pb-4">
                        <h2 className="text-2xl font-bold text-primary-dark flex items-center gap-2">
                            <Icon name="users" size={24}/> Membros & Tarefas
                        </h2>
                        <div className="flex gap-2 w-full md:w-auto">
                            <input 
                                type="text" 
                                placeholder="Novo membro equipe..." 
                                className="flex-1 px-4 py-2 border rounded-lg outline-none focus:border-primary-light text-sm"
                                value={newMemberName}
                                onChange={(e) => setNewMemberName(e.target.value)}
                            />
                            <button onClick={handleAdd} className="btn-primary bg-primary-dark text-white px-4 py-2 flex items-center gap-2 text-sm whitespace-nowrap">
                                <Icon name="user-plus" size={16}/> Add Membro
                            </button>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {members.length === 0 ? (
                            <div className="col-span-full text-center py-10 text-gray-400 bg-white rounded-xl border border-dashed">Nenhum membro cadastrado.</div>
                        ) : (
                            members.map(member => {
                                const memberTasks = tasks.filter(t => t.responsavel === member.name).sort((a,b) => new Date(a.data) - new Date(b.data));
                                
                                return (
                                    <div key={member.id} className="bg-white rounded-xl border border-gray-200 shadow-sm flex flex-col h-96">
                                        <div className="bg-primary-light/10 px-4 py-3 border-b border-primary-light/20 flex justify-between items-center">
                                            <h3 className="font-bold text-primary-dark truncate">{member.name}</h3>
                                            <button onClick={() => onDeleteMember(member.id, member.name)} className="text-gray-400 hover:text-red-500"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto p-2 custom-scrollbar space-y-2">
                                            {memberTasks.length === 0 ? (
                                                <p className="text-xs text-gray-400 text-center mt-4">Nenhuma tarefa atribuída.</p>
                                            ) : (
                                                memberTasks.map(task => (
                                                    <div key={task.id} className={`p-2 rounded border flex items-start gap-2 ${task.completed ? 'bg-gray-50 border-gray-100 opacity-60' : 'bg-white border-blue-100 shadow-sm'}`}>
                                                        <button onClick={() => onToggleTask(task)} className={`mt-0.5 ${task.completed ? 'text-green-500' : 'text-gray-300 hover:text-blue-500'}`}>
                                                            <Icon name={task.completed ? "check-circle" : "circle"} size={18}/>
                                                        </button>
                                                        <div className="flex-1 min-w-0">
                                                            <p className={`text-sm font-medium ${task.completed ? 'line-through text-gray-500' : 'text-gray-800'}`}>{task.nome}</p>
                                                            <div className="flex justify-between items-center mt-1">
                                                                <span className="text-[10px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded">
                                                                    {new Date(task.data).toLocaleDateString('pt-BR')}
                                                                </span>
                                                                {task.completedDate && <span className="text-[9px] text-green-600">Feito em {new Date(task.completedDate).toLocaleDateString('pt-BR')}</span>}
                                                                <button onClick={() => onDeleteTask(task.id)} className="text-red-400 hover:text-red-600"><Icon name="trash-2" size={14}/></button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>
                </div>
            );
        };

        const AuthScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            const handleLogin = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setError('');
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                } catch (err) {
                    setError("Login falhou. Verifique suas credenciais.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100 p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8 text-center">
                        <div className="w-20 h-20 bg-primary-dark rounded-full mx-auto flex items-center justify-center mb-4">
                            <img src={LOGO_URL} className="w-12 h-12 object-contain" onError={(e)=>e.target.style.display='none'}/>
                        </div>
                        <h1 className="text-2xl font-bold text-gray-800 mb-6">Acesso ao Sistema</h1>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" placeholder="E-mail" className="w-full px-4 py-2 border rounded-lg" value={email} onChange={e=>setEmail(e.target.value)} required/>
                            <input type="password" placeholder="Senha" className="w-full px-4 py-2 border rounded-lg" value={password} onChange={e=>setPassword(e.target.value)} required/>
                            {error && <p className="text-red-500 text-sm">{error}</p>}
                            <button type="submit" disabled={isLoading} className="w-full btn-primary bg-primary-dark text-white py-2">
                                {isLoading ? 'Entrando...' : 'Entrar'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const CompletionModal = ({ isOpen, onClose, onConfirm, item }) => {
            if (!isOpen || !item) return null;
            const [date, setDate] = useState(formatDateForInput(new Date()));
            const isTask = item.tipo === 'tarefa';
            const title = isTask ? 'Concluir Tarefa' : (item.tipo === 'recebimento' ? 'Confirmar Recebimento' : 'Confirmar Pagamento');
            const verb = isTask ? 'concluída' : (item.tipo === 'recebimento' ? 'recebido' : 'pago');

            const handleSubmit = (e) => {
                e.preventDefault();
                onConfirm(date);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm overflow-hidden">
                        <div className="p-6">
                            <h3 className="font-bold text-lg text-primary-dark flex items-center gap-2">
                                <Icon name="check-circle" size={20}/> {title}
                            </h3>
                            <p className="mt-2 text-sm text-gray-600">Quando o item <strong>{item.nome}</strong> foi {verb}?</p>
                            <form onSubmit={handleSubmit} className="mt-4">
                                <label className="block text-xs font-bold text-gray-500 mb-1">Data de Conclusão</label>
                                <input type="date" required className="w-full px-3 py-2 border rounded-lg outline-none focus:border-primary-light" value={date} onChange={(e) => setDate(e.target.value)}/>
                                <div className="flex justify-end gap-3 mt-6">
                                    <button type="button" onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Cancelar</button>
                                    <button type="submit" className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium">Confirmar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const AppContext = createContext();

        function App() {
            const [user, setUser] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [isDataLoading, setIsDataLoading] = useState(true);
            
            // Estados Principais
            const [dividas, setDividas] = useState([]);
            const [recebimentos, setRecebimentos] = useState([]);
            const [pagamentos, setPagamentos] = useState({});
            const [recebimentoStatus, setRecebimentoStatus] = useState({});
            const [tasks, setTasks] = useState([]);
            const [members, setMembers] = useState([]);
            
            // Estados CommitCoin
            const [coinMembers, setCoinMembers] = useState([]); 
            const [commitCoins, setCommitCoins] = useState({}); 
            const [storeProducts, setStoreProducts] = useState([]); 

            const [viewDate, setViewDate] = useState(new Date());
            const [showModal, setShowModal] = useState(false);
            const [view, setView] = useState('calendario');
            const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [isCompletionModalOpen, setIsCompletionModalOpen] = useState(false);
            const [itemToComplete, setItemToComplete] = useState(null);
            const [alerts, setAlerts] = useState([]);
            const [showNotifications, setShowNotifications] = useState(false);

            const [newItem, setNewItem] = useState({ 
                tipo: 'divida', nome: '', valor: '', dia: '', mesInicio: new Date().getMonth() + 1, anoInicio: new Date().getFullYear(), parcelas: '1', responsavel: '', dataTarefa: formatDateForInput(new Date()) 
            });

            const USER_DOC_REF = user ? db.collection("shared_finances").doc(GLOBAL_DATA_ID) : null;

            useEffect(() => {
                const unsub = auth.onAuthStateChanged(u => { setUser(u); setIsAuthReady(true); });
                return () => unsub();
            }, []);

            useEffect(() => {
                if (!user || !USER_DOC_REF) { setIsDataLoading(false); return; }
                const unsub = USER_DOC_REF.onSnapshot(doc => {
                    if (doc.exists) {
                        const d = doc.data();
                        setDividas(d.dividas || []);
                        setRecebimentos(d.recebimentos || []);
                        setPagamentos(d.pagamentos || {});
                        setRecebimentoStatus(d.recebimentoStatus || {});
                        setTasks(d.tasks || []);
                        setMembers(d.members || []);
                        setCoinMembers(d.coinMembers || []); 
                        setCommitCoins(d.commitCoins || {});
                        setStoreProducts(d.storeProducts || []);
                    } else {
                        saveDataToFirebase(USER_DOC_REF, { dividas: [], recebimentos: [], pagamentos: {}, recebimentoStatus: {}, tasks: [], members: [], coinMembers: [], commitCoins: {}, storeProducts: [] });
                    }
                    setIsDataLoading(false);
                });
                return () => unsub();
            }, [user]);

            useEffect(() => {
                if (isDataLoading) return;
                const today = new Date();
                const detected = [];
                const checkFinancial = (items, map, type) => {
                    items.forEach(i => {
                        const due = new Date(today.getFullYear(), today.getMonth(), i.dia);
                        const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                        if (diff >= 0 && diff <= 2) {
                            const monthDiff = getMonthDifference(i.mesInicio, i.anoInicio, today.getMonth() + 1, today.getFullYear());
                            if (monthDiff >= 0 && monthDiff < i.parcelas) {
                                const key = getStatusKey(i.id, monthDiff);
                                if (!map[key]) detected.push({ ...i, dia: i.dia, tipo: type });
                            }
                        }
                    });
                };
                checkFinancial(dividas, pagamentos, 'divida');
                tasks.forEach(t => {
                    if (!t.completed) {
                        const due = new Date(t.data);
                        const diff = Math.ceil((due - today) / (1000 * 60 * 60 * 24));
                        if (diff >= 0 && diff <= 2) detected.push({ ...t, dia: due.getDate(), tipo: 'tarefa' });
                    }
                });
                setAlerts(detected);
            }, [dividas, pagamentos, tasks, isDataLoading]);

            // Handlers
            const handleAddItem = (e) => {
                e.preventDefault();
                if (!USER_DOC_REF) return;
                if (newItem.tipo === 'tarefa') {
                    const task = { id: Date.now().toString(), nome: newItem.nome, responsavel: newItem.responsavel, data: newItem.dataTarefa, completed: false, tipo: 'tarefa' };
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, members, coinMembers, tasks: [...tasks, task], commitCoins, storeProducts });
                } else {
                    const item = { id: Date.now().toString(), nome: newItem.nome, valor: parseFloat(newItem.valor), dia: parseInt(newItem.dia), parcelas: parseInt(newItem.parcelas), mesInicio: parseInt(newItem.mesInicio), anoInicio: parseInt(newItem.anoInicio), tipo: newItem.tipo, responsavel: newItem.responsavel };
                    const newD = newItem.tipo === 'divida' ? [...dividas, item] : dividas;
                    const newR = newItem.tipo !== 'divida' ? [...recebimentos, item] : recebimentos;
                    saveDataToFirebase(USER_DOC_REF, { dividas: newD, recebimentos: newR, pagamentos, recebimentoStatus, members, coinMembers, tasks, commitCoins, storeProducts });
                }
                setShowModal(false);
                setNewItem({ tipo: 'divida', nome: '', valor: '', dia: '', mesInicio: new Date().getMonth()+1, anoInicio: new Date().getFullYear(), parcelas: '1', responsavel: '', dataTarefa: formatDateForInput(new Date()) });
            };

            const handleDeleteItem = () => {
                if (!itemToDelete || !USER_DOC_REF) return;
                const { id, tipo } = itemToDelete;
                
                if (tipo === 'tarefa') {
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, members, coinMembers, tasks: tasks.filter(t => t.id !== id), commitCoins, storeProducts });
                } else if (tipo === 'divida') {
                    saveDataToFirebase(USER_DOC_REF, { dividas: dividas.filter(d => d.id !== id), recebimentos, pagamentos, recebimentoStatus, members, coinMembers, tasks, commitCoins, storeProducts });
                } else if (tipo === 'recebimento') {
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos: recebimentos.filter(r => r.id !== id), pagamentos, recebimentoStatus, members, coinMembers, tasks, commitCoins, storeProducts });
                } else if (tipo === 'member') {
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, coinMembers, members: members.filter(m => m.id !== id), commitCoins, storeProducts });
                } else if (tipo === 'coinMember') {
                    const newCoins = {...commitCoins}; delete newCoins[id];
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, members, coinMembers: coinMembers.filter(m => m.id !== id), commitCoins: newCoins, storeProducts });
                } else if (tipo === 'product') {
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, members, coinMembers, commitCoins, storeProducts: storeProducts.filter(p => p.id !== id) });
                }
                
                setIsConfirmModalOpen(false); setItemToDelete(null);
            };

            const handleCompletionConfirm = (date) => {
                if (!USER_DOC_REF || !itemToComplete) return;
                if (itemToComplete.tipo === 'tarefa') {
                    saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, members, coinMembers, tasks: tasks.map(t => t.id === itemToComplete.id ? { ...t, completed: true, completedDate: date } : t), commitCoins, storeProducts });
                } else {
                    const chave = itemToComplete.chave;
                    const updateMap = itemToComplete.tipo === 'divida' ? { ...pagamentos } : { ...recebimentoStatus };
                    updateMap[chave] = date;
                    const payload = itemToComplete.tipo === 'divida' ? { pagamentos: updateMap } : { recebimentoStatus: updateMap };
                    USER_DOC_REF.set(payload, { merge: true });
                }
                setIsCompletionModalOpen(false); setItemToComplete(null);
            };

            const requestCompletion = (item) => {
                const isCompleted = item.tipo === 'tarefa' ? item.completed : (item.tipo === 'divida' ? !!pagamentos[item.chave] : !!recebimentoStatus[item.chave]);
                if (isCompleted) {
                    if (item.tipo === 'tarefa') saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, members, coinMembers, tasks: tasks.map(t => t.id === item.id ? { ...t, completed: false, completedDate: null } : t), commitCoins, storeProducts });
                    else {
                        const updateMap = item.tipo === 'divida' ? { ...pagamentos } : { ...recebimentoStatus };
                        delete updateMap[item.chave];
                        USER_DOC_REF.set(item.tipo === 'divida' ? { pagamentos: updateMap } : { recebimentoStatus: updateMap }, { merge: true });
                    }
                } else {
                    setItemToComplete(item); setIsCompletionModalOpen(true);
                }
            };

            const addMember = (name) => {
                if (!USER_DOC_REF) return;
                const newId = Date.now().toString();
                saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, coinMembers, members: [...members, { id: newId, name }], commitCoins, storeProducts });
            };

            // Handlers CommitCoin e CoinMembers
            const addCoinMember = (name) => {
                if (!USER_DOC_REF) return;
                const newId = Date.now().toString();
                const newCoinMembers = [...coinMembers, { id: newId, name }];
                const newCoins = {...commitCoins, [newId]: 0};
                saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, members, coinMembers: newCoinMembers, commitCoins: newCoins, storeProducts });
            };

            const updateCoins = (memberId, amount) => {
                if (!USER_DOC_REF) return;
                const current = commitCoins[memberId] || 0;
                saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, members, coinMembers, commitCoins: { ...commitCoins, [memberId]: current + amount }, storeProducts });
            };

            const addProduct = (product) => {
                if (!USER_DOC_REF) return;
                saveDataToFirebase(USER_DOC_REF, { dividas, recebimentos, pagamentos, recebimentoStatus, tasks, members, coinMembers, commitCoins, storeProducts: [...storeProducts, { ...product, id: Date.now().toString() }] });
            };

            const renderCalendar = () => {
                const year = viewDate.getFullYear();
                const month = viewDate.getMonth();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDay = new Date(year, month, 1).getDay();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(<div key={`empty-${i}`} className="h-28 bg-gray-50/50 border border-gray-100"></div>);
                for (let d = 1; d <= daysInMonth; d++) {
                    const financialItems = [];
                    const checkFin = (list, type, map) => {
                        list.forEach(item => {
                            const diff = getMonthDifference(item.mesInicio, item.anoInicio, month + 1, year);
                            if (diff >= 0 && diff < item.parcelas && item.dia === d) {
                                const key = getStatusKey(item.id, diff);
                                financialItems.push({ ...item, tipo: type, chave: key, pago: !!map[key] });
                            }
                        });
                    };
                    checkFin(dividas, 'divida', pagamentos);
                    checkFin(recebimentos, 'recebimento', recebimentoStatus);
                    const currentDateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    const dailyTasks = tasks.filter(t => t.data === currentDateStr);
                    const isToday = new Date().getDate() === d && new Date().getMonth() === month && new Date().getFullYear() === year;
                    days.push(
                        <div key={d} className={`h-28 border border-gray-100 p-1 relative overflow-hidden group ${isToday ? 'bg-primary-light/5' : 'bg-white'}`}>
                            <span className={`text-xs font-bold w-6 h-6 flex items-center justify-center rounded-full mb-1 ${isToday ? 'bg-primary-dark text-white' : 'text-gray-400'}`}>{d}</span>
                            <div className="flex flex-col gap-1 overflow-y-auto max-h-[calc(100%-24px)] custom-scrollbar">
                                {financialItems.map(item => (
                                    <div key={item.chave} onClick={() => requestCompletion(item)} className={`text-[10px] px-1 py-0.5 rounded border truncate cursor-pointer select-none flex flex-col justify-center ${item.pago ? 'opacity-50 line-through bg-gray-100' : (item.tipo === 'divida' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-green-50 text-green-700 border-green-100')}`}>
                                        <div className="flex justify-between"><span>{item.nome}</span>{!item.pago && <span>R${item.valor}</span>}</div>
                                        {item.responsavel && <span className="text-[8px] opacity-70">{item.responsavel}</span>}
                                    </div>
                                ))}
                                {dailyTasks.map(task => (
                                    <div key={task.id} onClick={() => requestCompletion(task)} className={`text-[10px] px-1 py-0.5 rounded border truncate cursor-pointer select-none flex items-center gap-1 ${task.completed ? 'bg-gray-100 text-gray-400 line-through' : 'bg-blue-50 text-blue-700 border-blue-100'}`}>
                                        <Icon name={task.completed ? "check" : "circle"} size={10}/>
                                        <span className="truncate flex-1">{task.nome}</span>
                                        <span className="text-[8px] uppercase bg-white/50 px-1 rounded">{task.responsavel.slice(0,3)}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                }
                return days;
            };

            // Processar lista completa de despesas para o Quadro de Administração
            const allExpenses = useMemo(() => {
                const list = [];
                const targetMonth = viewDate.getMonth() + 1;
                const targetYear = viewDate.getFullYear();

                dividas.forEach(item => {
                    // Lógica ajustada: Filtrar APENAS o mês que está sendo visualizado no calendário
                    const diff = getMonthDifference(item.mesInicio, item.anoInicio, targetMonth, targetYear);
                    
                    // Se a parcela existe neste mês específico (diff >= 0 e menor que o total de parcelas)
                    if (diff >= 0 && diff < item.parcelas) {
                        const key = getStatusKey(item.id, diff);
                        const isPaid = !!pagamentos[key];
                        
                        list.push({ 
                            ...item, 
                            chaveStatus: key, 
                            estaPago: isPaid, 
                            parcelaReal: diff + 1, 
                            mesReal: targetMonth, 
                            anoReal: targetYear 
                        });
                    }
                });
                return list;
            }, [dividas, pagamentos, viewDate]);

            if (!isAuthReady) return <div className="h-screen flex items-center justify-center"><Icon name="loader-2" size={48} className="animate-spin text-primary-dark"/></div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-primary-light border-b border-gray-200 sticky top-0 z-10 shadow-sm">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <h1 className="font-bold text-xl tracking-tight text-white hidden md:block">Financeiro <span className="text-accent-yellow">Commit JR</span></h1>
                                <h1 className="font-bold text-xl tracking-tight text-white md:hidden">Commit <span className="text-accent-yellow">JR</span></h1>
                            </div>
                            <div className="flex items-center gap-2 bg-primary-dark/30 rounded-full p-1 overflow-x-auto max-w-[200px] md:max-w-none custom-scrollbar">
                                <button onClick={() => setView('calendario')} className={`btn-nav px-4 py-1.5 rounded-full text-sm font-semibold flex items-center gap-2 ${view === 'calendario' ? 'bg-white text-primary-dark shadow-sm' : 'text-white hover:bg-white/10'}`}><Icon name="calendar" size={16}/> Calendário</button>
                                <button onClick={() => setView('coins')} className={`btn-nav px-4 py-1.5 rounded-full text-sm font-semibold flex items-center gap-2 ${view === 'coins' ? 'bg-white text-primary-dark shadow-sm' : 'text-white hover:bg-white/10'}`}><Icon name="coins" size={16}/> Coins</button>
                            </div>
                            <div className="flex items-center gap-3">
                                {view === 'calendario' && <div className="hidden md:flex items-center bg-white/10 rounded-full"><button onClick={() => setViewDate(new Date(viewDate.setMonth(viewDate.getMonth()-1)))} className="p-1.5 text-white hover:bg-white/20 rounded-full"><Icon name="chevron-left" size={16}/></button><span className="text-white text-xs font-bold w-24 text-center">{viewDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'}).toUpperCase()}</span><button onClick={() => setViewDate(new Date(viewDate.setMonth(viewDate.getMonth()+1)))} className="p-1.5 text-white hover:bg-white/20 rounded-full"><Icon name="chevron-right" size={16}/></button></div>}
                                <button onClick={() => setShowNotifications(true)} className="relative p-2 text-white hover:bg-white/10 rounded-full bell-ring"><Icon name="bell" size={20}/>{alerts.length > 0 && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border border-primary-light"></span>}</button>
                                <button onClick={() => setShowModal(true)} className="bg-accent-yellow text-primary-dark p-2 rounded-full shadow-lg hover:brightness-110 transition-all"><Icon name="plus" size={20}/></button>
                                <button onClick={() => auth.signOut()} className="text-white/70 hover:text-white p-1"><Icon name="log-out" size={20}/></button>
                            </div>
                        </div>
                    </nav>

                    {view === 'calendario' && (
                        <main className="max-w-6xl mx-auto px-4 py-6 space-y-8">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-2 space-y-2">
                                    <div className="grid grid-cols-7 text-center text-xs font-bold text-gray-400 mb-2"><div>DOM</div><div>SEG</div><div>TER</div><div>QUA</div><div>QUI</div><div>SEX</div><div>SÁB</div></div>
                                    <div className="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-xl overflow-hidden shadow-sm">{renderCalendar()}</div>
                                </div>
                                <div className="h-full">
                                    <AllExpensesBoard expenses={allExpenses} onToggle={(item) => requestCompletion(item)} onDelete={(id, tipo) => { setItemToDelete({id, tipo}); setIsConfirmModalOpen(true); }} />
                                </div>
                            </div>
                            
                            <TaskBoard 
                                members={members} 
                                tasks={tasks} 
                                onAddMember={addMember} 
                                onDeleteMember={(id, name) => { setItemToDelete({id, tipo:'member', name}); setIsConfirmModalOpen(true); }} 
                                onToggleTask={requestCompletion} 
                                onDeleteTask={(id) => { setItemToDelete({id, tipo:'tarefa', nome: 'Tarefa'}); setIsConfirmModalOpen(true); }}
                            />
                        </main>
                    )}
                    
                    {view === 'coins' && <CommitCoinView coinMembers={coinMembers} coinData={commitCoins} products={storeProducts} onUpdateCoins={updateCoins} onAddProduct={addProduct} onDeleteProduct={(id, name) => { setItemToDelete({id, tipo:'product', nome: name || 'Produto'}); setIsConfirmModalOpen(true); }} onAddCoinMember={addCoinMember} onDeleteCoinMember={(id, name) => { setItemToDelete({id, tipo:'coinMember', nome: name}); setIsConfirmModalOpen(true); }}/>}

                    {showModal && (
                        <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-md overflow-hidden">
                                <div className="bg-primary-dark px-6 py-4 flex justify-between items-center text-white"><h3 className="font-bold">Adicionar Novo</h3><button onClick={() => setShowModal(false)} className="opacity-70 hover:opacity-100">✕</button></div>
                                <form onSubmit={handleAddItem} className="p-6 space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 uppercase mb-1">O que é?</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            {['divida', 'recebimento', 'tarefa'].map(t => (
                                                <button key={t} type="button" onClick={() => setNewItem({...newItem, tipo: t})} className={`py-2 text-sm font-semibold rounded-lg border capitalize ${newItem.tipo === t ? 'bg-primary-dark text-white border-primary-dark' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}>{t === 'divida' ? 'Despesa' : t === 'recebimento' ? 'Receita' : 'Tarefa'}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Descrição</label><input required className="w-full px-3 py-2 border rounded-lg" value={newItem.nome} onChange={e => setNewItem({...newItem, nome: e.target.value})} placeholder={newItem.tipo === 'tarefa' ? 'Ex: Cobrar Cliente' : 'Ex: Aluguel'}/></div>
                                    
                                    {newItem.tipo !== 'tarefa' ? (
                                        <>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Valor (R$)</label><input required type="number" step="0.01" className="w-full px-3 py-2 border rounded-lg" value={newItem.valor} onChange={e => setNewItem({...newItem, valor: e.target.value})}/></div>
                                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Dia Venc.</label><input required type="number" min="1" max="31" className="w-full px-3 py-2 border rounded-lg" value={newItem.dia} onChange={e => setNewItem({...newItem, dia: e.target.value})}/></div>
                                            </div>
                                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Responsável (Opcional)</label><select className="w-full px-3 py-2 border rounded-lg bg-white" value={newItem.responsavel} onChange={e => setNewItem({...newItem, responsavel: e.target.value})}><option value="">Selecione...</option>{members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></div>
                                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-100 grid grid-cols-3 gap-3">
                                                <div><label className="text-[10px] font-bold text-gray-400">Parcelas</label><input type="number" min="1" className="w-full p-1 border rounded text-sm" value={newItem.parcelas} onChange={e => setNewItem({...newItem, parcelas: e.target.value})}/></div>
                                                <div><label className="text-[10px] font-bold text-gray-400">Mês Início</label><input type="number" min="1" max="12" className="w-full p-1 border rounded text-sm" value={newItem.mesInicio} onChange={e => setNewItem({...newItem, mesInicio: e.target.value})}/></div>
                                                <div><label className="text-[10px] font-bold text-gray-400">Ano Início</label><input type="number" className="w-full p-1 border rounded text-sm" value={newItem.anoInicio} onChange={e => setNewItem({...newItem, anoInicio: e.target.value})}/></div>
                                            </div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="grid grid-cols-2 gap-4">
                                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Data</label><input required type="date" className="w-full px-3 py-2 border rounded-lg" value={newItem.dataTarefa} onChange={e => setNewItem({...newItem, dataTarefa: e.target.value})}/></div>
                                                <div><label className="block text-xs font-bold text-gray-500 uppercase mb-1">Responsável</label><select required className="w-full px-3 py-2 border rounded-lg bg-white" value={newItem.responsavel} onChange={e => setNewItem({...newItem, responsavel: e.target.value})}><option value="">Selecione...</option>{members.map(m => <option key={m.id} value={m.name}>{m.name}</option>)}</select></div>
                                            </div>
                                            {members.length === 0 && <p className="text-xs text-red-500 mt-1">* Adicione membros na aba Membros primeiro.</p>}
                                        </>
                                    )}
                                    <div className="pt-2"><button type="submit" className="w-full btn-primary bg-primary-dark text-white py-3 rounded-lg shadow-lg">Salvar</button></div>
                                </form>
                            </div>
                        </div>
                    )}

                    <ConfirmModal isOpen={isConfirmModalOpen} onClose={() => setIsConfirmModalOpen(false)} onConfirm={handleDeleteItem} item={itemToDelete}/>
                    <CompletionModal isOpen={isCompletionModalOpen} onClose={() => setIsCompletionModalOpen(false)} onConfirm={handleCompletionConfirm} item={itemToComplete} />
                    <NotificationModal isOpen={showNotifications} onClose={() => setShowNotifications(false)} alerts={alerts} />
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
